<%
  page_data(
    title: "Checking bulk actions",
    error: @pending_induction_submission_batch.errors.present?,
    backlink_href: new_ab_batch_action_path,
  )
%>

<%= batch_progress_card(@pending_induction_submission_batch) %>
<%= batch_raw_data_table(@pending_induction_submission_batch) %>
<%= batch_processed_data_table(@pending_induction_submission_batch) %>
<%= batch_download_data_table(@pending_induction_submission_batch) %>

<%= govuk_button_link_to 'Download CSV', ab_batch_action_path(@pending_induction_submission_batch, format: :csv), secondary: true %>

<% if @pending_induction_submission_batch.processed? %>
  <%= govuk_button_link_to 'Confirm actions', edit_ab_batch_action_path(@pending_induction_submission_batch) %>
<% end %>

<%=
  govuk_table(
    caption: "Last inductions (#{@pending_induction_submission_batch.submissions_with_induction_periods.count} periods)",
    head: %w[TRN FIRST LAST END TERMS OUTCOME],      
    rows: @pending_induction_submission_batch.submissions_with_induction_periods.map do |pending_induction_submission, induction_period|
      [
        pending_induction_submission.trn, 
        pending_induction_submission.trs_first_name, 
        pending_induction_submission.trs_last_name, 
        induction_period.finished_on&.to_fs(:iso8601) || '-', 
        induction_period.number_of_terms.to_s, 
        (induction_period.outcome || 'release')
      ]
    end,
  )
%>
