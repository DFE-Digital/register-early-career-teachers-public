# State machines

We have a number of state machines in our models that describe the valid transitions between different states that a model can be in (using the [state_machines-activerecord](https://github.com/state-machines/state_machines-activerecord) gem).

This document details the state machines and the various transitions that they support.

State diagrams are in the [mermaid](https://mermaid.js.org/) format and can be generated by pasting the state machine definitions from the model into your favourite AI chatbot.

## Statement

A statement has three possible states:

- `open` is the initial state of a statement - the `deadline_date` of the statement is in the future.
- `payable` when the `deadline_date` of the statement is now in the past (it is picked up by a background job).
- `paid` when the statement has been manually marked as paid by a finance user (historically a developer marked as paid with a rake task).

There are two transitions a statement can go through:

- `mark_as_payable` transitions a statement from `open` to the `payable` state. This happens when the `deadline_date` of the statement has passed.
- `mark_as_paid` transitions a statement from `payable` to `paid`. This happens when a finance user manually triggers the transition in the finance dashboard.

```mermaid
stateDiagram-v2
  [*] --> open
  open --> payable : mark_as_payable
  payable --> paid : mark_as_paid
```

## Statement::LineItem

A line item attached to a statement has more complexity and therefore supports a wider range of states and transitions.

A statement line item has the following possible payment states:

- `eligible` is the initial state of a line item that will progress towards payment.
- `payable` once it has been confirmed for payment.
- `paid` when the line item has been paid.
- `voided` when the line item as been cancelled before being paid.
- `ineligible` when the line item does not qualify for payment.

A statement line item has the following possible refund states:

- `awaiting_clawback` is the initial state of a line item that will progress towards a refund.
- `clawed_back` once the amount has successfully been reclaimed.

There are seven transitions a line item can go through:

- `mark_as_payable` transitions a line item from `eligible` to `payable`. This happens on a daily job that picks up statements when the `deadline_date` has passed.
- `mark_as_paid` transitions a line item from `payable` to `paid`. This happens when a finance user marks a statement as paid in the finance dashboard.
- `mark_as_voided` transitions a line item from `eligible`, `ineligible` or `payable` to `voided`. This happens when a lead provider voids an unpaid declaration.
- `mark_as_clawed_back` transitions a line item from `awaiting_clawback` to `clawed_back`. This happens when a statement is marked aws paid in the finance dashboard.
- `mark_as_ineligible` transitions a line item from `eligible` to `ineligible`. This happens when a newly submitted declaration is superseeded.

```mermaid
stateDiagram-v2
  [*] --> eligible
  [*] --> awaiting_clawback
  eligible --> payable : mark_as_payable
  payable --> paid : mark_as_paid
  awaiting_clawback --> clawed_back : mark_as_clawed_back
  eligible --> ineligible : mark_as_ineligible
  eligible --> voided : mark_as_voided
  payable --> voided : mark_as_voided
  ineligible --> voided : mark_as_voided
```

## Declaration

A declaration supports the same states as a `Statement::LineItem` but also has a `submitted` state in addition:

- `submitted` is the initial state of a declaration; if the participant is not eligible for funding and there are no duplicate declarations then the declaration remains in this state.

A declaration has the same transitions as a `Statement::LineItem` but also supports:

- `mark_as_eligible` transitions a line item from `submitted` to `eligible`. This happens on submitting a declaration if there are no duplicates and the participant is eligible for funding.
- `mark_as_ineligible` transitions a line item from `submitted` to `ineligible`. This happens when there is a duplicate declaration for the participant.

```mermaid
stateDiagram-v2
  [*] --> submitted
  submitted --> eligible : mark_as_eligible
  submitted --> ineligible: mark_as_ineligible
  eligible --> payable : mark_as_payable
  payable --> paid : mark_as_paid
  paid --> awaiting_clawback : mark_as_awaiting_clawback
  awaiting_clawback --> clawed_back : mark_as_clawed_back
  eligible --> ineligible : mark_as_ineligible
  eligible --> voided : mark_as_voided
  payable --> voided : mark_as_voided
  ineligible --> voided : mark_as_voided
```
